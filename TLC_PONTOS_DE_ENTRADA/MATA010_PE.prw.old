#include "Protheus.ch"
#include "FWMVCDEF.CH" 
#include "parmtype.CH" 
#include "TLC_DEFINE.CH" 

Static cMVRProd := GetMV('TI_TLCPROD',.F.,"SB1->B1_TIPO == 'PA'") // regra para identificar um produto
Static cMVRPeca := GetMV('TI_TLCPECA',.F.,"SB1->B1_TIPO == 'PI'") // regra para identificar uma peça

//-------------------------------------------------------------------
/*/{Protheus.doc} MATA010
Ponto de Entrada do Cadastro de Produtos (MVC)
@param      Não há
@return     Vários. Dependerá de qual PE está sendo executado.
@author     Emerson Nascimento TwoIT
@version    12.1.17 / Superior
@since      Abr/2025
/*/
//-------------------------------------------------------------------
User Function MATA010()
 
Local aParam        := PARAMIXB
Local xRet          := .T.
Local lIsGrid       := .F.
Local cIDPonto      := ''
Local cIDModel      := ''
Local cIDForm       := ''
Local cEvento       := ''
Local cCampo        := ''
Local cConteudo     := ''
Local oObj          := NIL
Local oAPIIntegr	 as object

If aParam <> NIL

	oObj        := aParam[1]
	cIDPonto    := aParam[2]
	cIDModel    := aParam[3]
	lIsGrid     := (Len(aParam) > 3)
	nOpc        := oObj:GetOperation()

	If cIDPonto == 'FORMPRE'
 
		cEvento     := aParam[4]
		cCampo      := aParam[5]
		cConteudo   := If( ValType(aParam[6]) == 'C',;
						   "'" + aParam[6] + "'",;
						   If( ValType(aParam[6]) == 'N',;
							   AllTrim(Str(aParam[6])),;
							   If( ValType(aParam[6]) == 'D',;
								   DtoC(aParam[6]),;
								   If(ValType(aParam[4]) == 'L',;
									  If(aParam[4], '.T.', '.F.'),;
									  ''))))
		cIDForm     := oObj:GetID()
 
	ElseIf cIDPonto == 'FORMPOS'
 
		cIDForm     := oObj:GetID()
 
	ElseIf cIDPonto == 'FORMCOMMITTTSPRE' .OR. cIDPonto == 'FORMCOMMITTTSPOS'
 
		cConteudo   := If( ValType(aParam[4]) == 'L',;
						   If( aParam[4], '.T.', '.F.'),;
						   '')
 
	EndIf
 
	If cIDPonto == 'MODELVLDACTIVE'
/*
		Valida se o modelo do cadastro de produtos pode ou não ser exibido ao usuário
*/
	ElseIf cIDPonto == 'MODELPRE'
/*
	   Antes da alteração de qualquer campo do Modelo
*/
	ElseIf cIDPonto == 'FORMPRE'
/*
		Antes da alteração de qualquer campo do Formulário
*/
	ElseIf cIDPonto == 'BUTTONBAR'
/*
		Adicionando um botão na barra de botões da rotina
*/
	ElseIf cIDPonto == 'FORMPOS'
/*
		Chamada na validação final do formulário
*/
	ElseIf  cIDPonto == 'MODELPOS'
/*
		Chamada na validação total do modelo
*/
	ElseIf cIDPonto == 'FORMCOMMITTTSPRE'
/*
		Chamada antes da gravação da tabela do formulário
*/
	ElseIf cIDPonto == 'FORMCOMMITTTSPOS'
/*
		Chamada após a gravação da tabela do formulário
*/
	ElseIf cIDPonto == 'MODELCOMMITTTS'
/*
		Chamada após a gravação total do modelo e dentro da transação
*/
	ElseIf cIDPonto == 'MODELCOMMITNTTS'
/*
		Chamada após a gravação total do modelo e fora da transação
*/
		oAPIProduto := Telecontrol.Integracao.Produto.TTLCProduto():New()
		if nOpc == MODEL_OPERATION_INSERT // inclusão
			oAPIProduto:Cadastra()
		elseif nOpc == MODEL_OPERATION_UPDATE // alteração	
			// consulta o cliente no telecontrol
			cCodRet := '500'
			if !oAPIProduto:Consulta(,@cCodRet) .OR. (cCodRet <> '200')
				oAPIAPIProduto:Cadastra()
			elseif (cCodRet == '200')
				oAPICliente:Altera()
			endif
		endif

	ElseIf cIDPonto == 'MODELCANCEL'
/*
		Chamada após o cancelamento da edição do cadastro do produto
*/
	EndIf
 
EndIf
 
Return xRet
